<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moon Sign | DEEP LOVERS LAB</title>

  <!-- Astronomy Engine (browser build) -->
  <script src="https://unpkg.com/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

  <style>
    :root{
      --bg:#050507;
      --panel:#0d0b10;
      --text:#f3eef7;
      --muted:#b8a9c6;
      --gold:#d7b46a;
      --wine:#5b1020;
      --line:rgba(215,180,106,.25);
    }
    body{
      margin:0;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(91,16,32,.35), transparent 60%),
        radial-gradient(700px 500px at 80% 0%, rgba(215,180,106,.12), transparent 60%),
        radial-gradient(900px 700px at 60% 100%, rgba(91,16,32,.20), transparent 65%),
        var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      letter-spacing: .02em;
    }
    .wrap{max-width:920px;margin:0 auto;padding:28px 18px 60px;}
    header{padding:18px 6px 10px;}
    .brand{
      font-weight:700;
      letter-spacing:.18em;
      color:var(--gold);
      font-size:12px;
      text-transform:uppercase;
    }
    h1{margin:10px 0 6px;font-size:28px;line-height:1.2;}
    .sub{color:var(--muted);margin:0 0 18px;line-height:1.7;}
    .panel{
      background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 35%), var(--panel);
      border:1px solid var(--line);
      border-radius:16px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
    @media (max-width:720px){.grid{grid-template-columns:1fr;}}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px;}
    input, select{
      width:100%;
      background:#09070c;
      color:var(--text);
      border:1px solid rgba(215,180,106,.22);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
    }
    input:focus, select:focus{border-color:rgba(215,180,106,.55);}
    .row{margin-top:12px;}
    button{
      width:100%;
      margin-top:14px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid rgba(215,180,106,.45);
      background:linear-gradient(90deg, rgba(91,16,32,.75), rgba(215,180,106,.18));
      color:var(--text);
      font-weight:700;
      letter-spacing:.08em;
      cursor:pointer;
    }
    button:hover{filter:brightness(1.05);}
    .result{
      margin-top:16px;
      padding:16px;
      border-radius:14px;
      border:1px solid rgba(215,180,106,.22);
      background:rgba(0,0,0,.25);
    }
    .big{font-size:22px;margin:0 0 6px;}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .note{color:var(--muted);line-height:1.75;margin:10px 0 0;font-size:13px;}
    .tiny{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.7;}
    .hr{height:1px;background:rgba(215,180,106,.18);margin:14px 0;}
    footer{margin-top:18px;color:rgba(184,169,198,.9);font-size:12px;line-height:1.7;}
    a{color:var(--gold);text-decoration:none;}
    a:hover{text-decoration:underline;}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">DEEP LOVERS LAB</div>
      <h1>Moon Sign Calculator</h1>
      <p class="sub">
        月は、感情の処理・安心の取り方・反応の癖。<br>
        生まれた瞬間の「月の星座」を、静かに可視化します。
      </p>
    </header>

    <section class="panel">
      <div class="grid">
        <div>
          <label>生年月日（必須）</label>
          <input id="date" type="date" />
        </div>
        <div>
          <label>出生時刻（任意）</label>
          <input id="time" type="time" placeholder="12:34" />
        </div>
      </div>

      <div class="grid row">
        <div>
          <label>タイムゾーン</label>
          <select id="tz">
            <option value="+09:00" selected>+09:00（日本）</option>
            <option value="+00:00">+00:00（UTC）</option>
            <option value="-05:00">-05:00</option>
            <option value="-08:00">-08:00</option>
            <option value="+01:00">+01:00</option>
            <option value="+10:00">+10:00</option>
          </select>
        </div>
        <div>
          <label>表示モード</label>
          <select id="mode">
            <option value="tropical" selected>トロピカル（一般的な西洋占星術）</option>
            <option value="note" disabled>※サイデリアル等は拡張で追加できます</option>
          </select>
        </div>
      </div>

      <button id="calc">月星座を出す</button>

      <div id="out" class="result" style="display:none"></div>

      <div class="tiny">
        ※出生時刻が不明の場合、月が星座の境界付近にあると結果が前後することがあります（目安：±1星座の可能性）。
      </div>
    </section>

    <footer>
      <div class="hr"></div>
      <div>
        計算には Astronomy Engine を使用しています。 [oai_citation:1‡Unpkg](https://app.unpkg.com/astronomy-engine%402.1.19/files/README.md)
      </div>
    </footer>
  </div>

<script>
  // 12 signs (tropical)
  const SIGNS = [
    {name:"牡羊座", key:"Aries",     start:0,   vibe:"反応が速い。安心は「今、動ける」ことで保たれる。"},
    {name:"牡牛座", key:"Taurus",    start:30,  vibe:"安心は「変わらない感触」。五感が落ち着くと心も静まる。"},
    {name:"双子座", key:"Gemini",    start:60,  vibe:"安心は「言葉の循環」。話せる/考えられると呼吸が戻る。"},
    {name:"蟹座",   key:"Cancer",    start:90,  vibe:"安心は「守る/守られる」。情が温度として心を支える。"},
    {name:"獅子座", key:"Leo",       start:120, vibe:"安心は「肯定される光」。自分を誇れると感情は整う。"},
    {name:"乙女座", key:"Virgo",     start:150, vibe:"安心は「整っていること」。小さな改善が心のノイズを消す。"},
    {name:"天秤座", key:"Libra",     start:180, vibe:"安心は「対等さ」。関係のバランスが戻ると感情も戻る。"},
    {name:"蠍座",   key:"Scorpio",   start:210, vibe:"安心は「深さ」。表面ではなく本音に触れたときに落ち着く。"},
    {name:"射手座", key:"Sagittarius",start:240,vibe:"安心は「見通し」。意味や未来が見えると心が軽くなる。"},
    {name:"山羊座", key:"Capricorn", start:270, vibe:"安心は「現実の強度」。守れる基盤があるほど感情は安定する。"},
    {name:"水瓶座", key:"Aquarius",  start:300, vibe:"安心は「自由と距離」。余白があるほど心は澄む。"},
    {name:"魚座",   key:"Pisces",    start:330, vibe:"安心は「溶ける境界」。優しさや共感で感情がほどけていく。"},
  ];

  function parseOffset(tzStr){
    // "+09:00" -> minutes
    const m = tzStr.match(/^([+-])(\d{2}):(\d{2})$/);
    if(!m) return 0;
    const sign = (m[1] === "-") ? -1 : 1;
    const hh = parseInt(m[2],10);
    const mm = parseInt(m[3],10);
    return sign * (hh*60 + mm);
  }

  function clamp360(deg){
    let x = deg % 360;
    if(x < 0) x += 360;
    return x;
  }

  function signFromLongitude(lon){
    // 0..360
    const idx = Math.floor(lon / 30) % 12;
    const degInSign = lon - idx*30;
    return { ...SIGNS[idx], degInSign };
  }

  function toUtcDate(dateStr, timeStr, tzStr){
    // dateStr: "YYYY-MM-DD"
    // timeStr: "HH:MM" or ""
    // tzStr: "+09:00"
    if(!dateStr) return null;
    const [Y,M,D] = dateStr.split("-").map(Number);
    let hh = 12, mm = 0; // time not provided -> noon (safer than midnight for boundary bias)
    if(timeStr){
      [hh,mm] = timeStr.split(":").map(Number);
    }
    const offsetMin = parseOffset(tzStr);
    // local time -> UTC: subtract offset
    const utcMillis = Date.UTC(Y, M-1, D, hh, mm) - offsetMin*60*1000;
    return new Date(utcMillis);
  }

  document.getElementById("calc").addEventListener("click", () => {
    const dateStr = document.getElementById("date").value;
    const timeStr = document.getElementById("time").value;
    const tzStr   = document.getElementById("tz").value;

    const utcDate = toUtcDate(dateStr, timeStr, tzStr);
    const out = document.getElementById("out");

    if(!utcDate){
      out.style.display = "block";
      out.innerHTML = `<div class="big">日付を入れてね</div><div class="note">生年月日（必須）が空です。</div>`;
      return;
    }

    // Use EclipticGeoMoon(date) -> Spherical (lon in degrees) in true ecliptic of date
    // From library docs/types: EclipticGeoMoon returns spherical ecliptic position of the Moon. [oai_citation:2‡Unpkg](https://app.unpkg.com/astronomy-engine%402.1.19/files/astronomy.d.ts)
    const sph = Astronomy.EclipticGeoMoon(utcDate);
    const lon = clamp360(sph.lon);

    const s = signFromLongitude(lon);

    const timeNote = timeStr
      ? `入力時刻：<span class="mono">${timeStr}</span>（TZ <span class="mono">${tzStr}</span>）`
      : `出生時刻が未入力のため、<b>12:00</b>（TZ <span class="mono">${tzStr}</span>）で仮計算しています。境界付近では結果が前後する可能性があります。`;

    out.style.display = "block";
    out.innerHTML = `
      <div class="big">あなたの月星座：<span style="color:var(--gold)">${s.name}</span></div>
      <div class="note">${timeNote}</div>
      <div class="hr"></div>
      <div class="note">
        月の黄経：<span class="mono">${lon.toFixed(2)}°</span><br>
        星座内の度数：<span class="mono">${s.degInSign.toFixed(2)}°</span>（${s.name} 0°〜29.99°）
      </div>
      <div class="hr"></div>
      <div class="note"><b>Moon tone</b><br>${s.vibe}</div>
    `;
  });

  // set default date example (optional): do nothing
</script>
</body>
</html>
